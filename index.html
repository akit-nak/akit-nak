<!DOCTYPE html>
<html>

    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>
            html {
                scrollbar-gutter: stable;
            }
            
            body {
                font-family: sans-serif;
                line-height: 1.4;
                font-size: 18px;
                max-width: 100%;
                margin: 0 auto;
            }
            img {
  max-width: 100%;
  height: auto;
}

            .grid {
                width: 100%;
                margin: 0 auto;
             }

             /* reveal grid after images loaded */
            .grid.are-images-unloaded {
                opacity: 0;
            }
            .grid__item {
                opacity: 0;

            }
            .grid__item img {
                  width: 100%;
  height: auto;

  display: block;
  margin-left: auto;
  margin-right: auto;
}

            .grid__item.is-loaded {
                opacity: 1;
            }

            .grid__item,
            .grid__col-sizer {
                width: 300px;
            }
@media (max-width: 600px) {
  .grid__item,
  .grid__col-sizer {
    width: 150px; /* スマホ用の固定値（2列構成） */
  }
}

            .grid__gutter-sizer { 
                width: 20px; 
                
            }
            
            /* hide by default */
            .grid.are-images-unloaded .image-grid__item {
                opacity: 0;
            }
            
            .grid__item {
              margin-bottom: 20px;
              float: left;
            }
            .photoset{
  max-width: 10%;
  height: auto;
  display: block;
}

            .page-load-status {
                display: none; /* hidden by default */
                padding-top: 20px;
                border-top: 1px solid #DDD;
                text-align: center;
                color: #777;
            }
            
            /* loader ellips in separate pen CSS */
        
        </style>
    </head>
    <body>
        <div class="grid are-images-unloaded">
            <div class="grid__col-sizer"></div>
            <div class="grid__gutter-sizer"></div>
            {block:Posts}
                <div class="grid__item">
                    {block:Text}
                        {block:NotReblog}
                            <article class="post" data-type="text">
                                <div>{Body}</div>
                            </article>
                        {/block:NotReblog}
                    {/block:Text}
                    {block:Photo}
                        {block:NotReblog}
                            <article class="post" data-type="photo">
                                <img src="{PhotoURL-HighRes}" alt="{PhotoAlt}" width="{PhotoWidth-HighRes}" height="{PhotoHeight-HighRes}">
                            </article>
                        {/block:NotReblog}
                    {/block:Photo}
                    {block:Photoset}
                        {block:NotReblog}
                            <article class="post" data-type="photoset">
                                {Photoset}
                            </article>
                        {/block:NotReblog}
                    {/block:Photoset}
                    {block:Video}
                         {block:NotReblog}
                            <article class="post" data-type="video">
                                {Video-700}
                            </article>
                        {/block:NotReblog}
                    {/block:Video}
                 </div>
            {/block:Posts}
        </div>

        <div class="page-load-status">
            <div class="loader-ellips infinite-scroll-request">
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
                <span class="loader-ellips__dot"></span>
            </div>
            <p class="infinite-scroll-last">End of content</p>
            <p class="infinite-scroll-error">No more pages to load</p>
            
        </div>
        
        <footer>
            {block:Pagination}
                <nav class="pagination">
                    <ul id="pagination">
                        {block:PreviousPage}
				            <li><a href="{PreviousPage}">«</a></li>
			            {/block:PreviousPage}
			            {block:JumpPage}
				            <li><a class="jump_page numbersNav" href="{URL}">{PageNumber}</a></li>
			            {/block:JumpPage}
			            {block:CurrentPage}
				            <li><span class="current_page numbersNav"><strong>{PageNumber}</strong></span></li>
			            {/block:CurrentPage}
			             {block:NextPage}
				            <li><a class="next" href="{NextPage}">»</a></li>
			            {/block:NextPage}
			         </ul>
		        </nav>
            {/block:Pagination}
        </footer>



    </body>
     
    
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/infinite-scroll@5/dist/infinite-scroll.pkgd.min.js"></script>
    
    <script>
    //----------------------------------------------
    // ▼ function
    //----------------------------------------------

        // Check if post contains image
        function isImagePost(item) {
            return !!item.querySelector('figure img');
        }
        
        
        // Check if post contains image and video
        function isVideoPost(item) {
            return item.querySelector('video, iframe[src*="youtube"], iframe[src*="vimeo"]');
        }
        
        /**
         * stripTextFromItem
         * - pタグのうち、画像・動画を含まないものを削除する
         * - Masonry配置前に不要なテキストを除去する責務
         */

        function stripTextFromItem(item) {
            const paragraphs = item.querySelectorAll('p');
            console.log(item);
            paragraphs.forEach(p => {
                const hasImage = p.querySelector('img');
                const hasVideo = p.querySelector('video, iframe[src*="youtube"], iframe[src*="vimeo"]');

                if (!hasImage && !hasVideo)  {
                    p.remove(); // Delete the contents of p tags that do not contain images and videos.
                }
            });
        return item;
        }
        
        // Check if it is filled with grid items
        function isGridVisuallyFull(gridElement, msnry) {
            const items = Array.from(gridElement.querySelectorAll('.grid__item'));
            const viewportBottom = window.innerHeight;
            const columnCount = msnry.cols;
            //console.log('viewportBottom',viewportBottom );
            //console.log('columnCount',columnCount);
            const overflowingItems = items.filter(item => {
                const itemBottom = item.getBoundingClientRect().bottom;
                //console.log('itemBottom',itemBottom);
                return itemBottom > viewportBottom;
            });
            return overflowingItems.length >= columnCount;
        }


        // Called during initial display and resizing. 
        // If there are few grid items, load the next page.
        function fillGridSparse(grid, infScroll, msnry) {
            if (isGridVisuallyFull(grid, msnry)) return;
            console.log('Load Next Page');
            infScroll.loadNextPage();
        }

    </script>
    
    <script>
    //----------------------------------------------
    // ▼ Init
    //----------------------------------------------

        // Called after the DOM is constructed. 
        // Image loading may not be complete.
        document.addEventListener('DOMContentLoaded', () => {
            
            let grid = document.querySelector('.grid');
            let reachedLastPage = false;
            
            // Initialization masonry
            let msnry = new Masonry( grid, {
                itemSelector: 'none', // select none at first
                columnWidth: '.grid__col-sizer',
                gutter: '.grid__gutter-sizer',
                fitWidth: true,
                percentPosition: false,
                stagger: 5,
                transitionDuration: '0.5s',
                // nicer reveal transition
                visibleStyle: {opacity: 1 },
                hiddenStyle: {opacity: 0 },
            });
            
            // Initialization infinite-scroll
            let infScroll = new InfiniteScroll( grid, {
                path: '#pagination li a.next',
                append: '.grid__item',
               // scrollThreshold: 1,
               // outlayer: msnry,  // Add manually to masonry
                status: '.page-load-status',
                history: false,
            });

            // Initialization process performed only once
            imagesLoaded( grid, function() {
               
                grid.classList.remove('are-images-unloaded');
                msnry.options.itemSelector = '.grid__item';
                let items = grid.querySelectorAll('.grid__item');
                
                items.forEach(item => {
                    if (!isImagePost(item) && !isVideoPost(item)) {
                        item.remove(); // Delete text-only posts
                        return;
                    }
                    
                    stripTextFromItem(item); // Remove text from posts containing images
                    item.classList.add('is-loaded'); // Change to display class
                });
                
                msnry.appended(items); // Since the post size changes, manually append it to the masonry layout.
                
                // Window resize event
                window.addEventListener('resize', () => {
                    console.log('resize');
                    if (!reachedLastPage){
                        msnry.reloadItems();
                      //  msnry.layout();
                    }
                });
            });
            
            // Called when the msnry layout completed
            msnry.on( 'layoutComplete', function( items ) {
                console.log('layoutComplete');
                fillGridSparse(grid, infScroll, msnry);
            });



            // Called when the new items has been appended
            infScroll.on('append', function(body, path, items, response) {
                console.log('infScroll on append');
                const validItems = [];
                items.forEach(item => {
                    if (!isImagePost(item)) {
                        item.remove();
                        return;
                    }

                    const img = item.querySelector('img');
                    if (img.naturalHeight === 0) {
                        const originalSrc = img.src;
                        const reloadSrc = originalSrc + (originalSrc.includes('?') ? '&' : '?') + 'reload=' + Date.now();
                        img.src = reloadSrc;
                    }

                    stripTextFromItem(item);
                    validItems.push(item);
                });

                // ✅ すべての画像が読み込まれたら一括レイアウト
                imagesLoaded(validItems, () => {
                    validItems.forEach(item => item.classList.add('is-loaded'));

                    msnry.appended(validItems); // Add items loaded via scrolling to the masonry grid
                    msnry.layout(); // ✅ 全体の高さが確定した後にレイアウト
                });
            });
            
            // Called when the last page is reached
            infScroll.on('last', () => {
                console.log('Reached the last page');
                reachedLastPage = true;
            });
        });
    </script>
</html>
